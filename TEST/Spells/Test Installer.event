//Master Animation Installer
//Macros
#define setCSATable(index, framedata, RTLFG, LTRFG, RTLBG, LTRBG) "PUSH; ORG CSATable+(index*20); POIN framedata RTLFG LTRFG RTLBG LTRBG; POP"
#define setCustomSpell_dim(index) "PUSH; ORG SpellTable+(index*4); POIN CSAEngine_Dim|1; POP"
#define setCustomSpell_nodim(index) "PUSH; ORG SpellTable+(index*4); POIN CSAEngine_NoDim|1; POP"

#ifdef _FE8_
  #define SpellTable $5d4e60
  #define CSATable $EF2F20 //CHANGE THIS TO A LOCATION WHERE YOU KNOW THERE ARE 0x13EC BYTES OF FREE SPACE

  PUSH
  ORG CSATable
  #incbin BlankCSATable.dmp

  ORG $95d780
  #incbin "CSA System_fe8.dmp" //the custom spell engine. All custom spells point here.
  POIN CSATable //needed for the routine
  POP
  
  #define CSAEngine_Dim $95d7ec
  #define CSAEngine_NoDim $95d898 //the last word in the dmp, this should be updated if you edit the engine.
  
  
  //MESSAGE No Dim is at CSAEngine_NoDim
  //MESSAGE Dim is at CSAEngine_Dim
#endif

ALIGN 4
#inctext lyn "SpellFix.elf" "SpellFixHook.elf"

{
ALIGN 4
#include "Spells/Aura/Aura.event"
}

// Notes comparaing against FEDitor's engine:

// Everything seems identical except starting at 0x0895D890. Then it looks like they completely diverge.
	// Buildfile has this massive extra step involving a loop...
	// There don't seem to be any discrepancies in the initial spell engine routine...

// In the 0x1A command, FEDitor skips to the end after the HP stealing check. Buidfile does not. Doing what FEDitor does seems to fix a couple issues.
// I've also found that the animation will only hang if there are frames in between the 0x1A command and the miss terminator.
	
	
	
	
// LIST OF DISCREPANCIES
	// The TSA loop at line 208ish exists in the FEDitor version
		// NO EFFECT WHEN NOT INCLUDING THE SCREEN STRETCHING PART
			// ALSO NO EFFECT WHEN ADDING SCREEN STRETCHING
	// In command 0x1A, FEDitor skips to the end after the HP stealing stuff... this seems to be better and fix shtuff. SOMETIMES
		// Apparently not? Now I'm having the opposite effect: Skipping the buildfile part makes it hang while not skipping it just makes it skip frames after the miss terminator
			// See notes below for combinations and effects
	// At line 611ish, a bunch of stuff changes
		// Along with 638ish, and 653ish
		// LOADS NO GRAPHICS
	// At line 733ish, a swi 0x12 is used in the FEDitor version instead of other stuff
		// ONLY SCREWES UP GRAPHICS
	// Small change at 764ish
		// THIS BREAKS SHIT
	// Wrong value used at 796... HEAP used instead of BASE...?
		// NO EFFECT?
	// Numerical changes at 801ish
		// NO EFFECT? 
	// Changes at 806ish
		// NO EFFECT?
	// MAP_1_TSA_HEAP should be 0x023FC00
		// NO REFERENCE IN BUILDFILE VERSION
	// BG_SHEET_PTR should be 0x06002000
		// NO EFFECT?
	
	
	// Skip 0x1A + No second miss terminator = CRASH
	// Skip 0x1A + Second miss terminator = SKIP FRAMES AFTER TERMINATOR // lolwut crashing now?
	// Regular 0x1A + No second miss terminator = SKIP FRAMES AFTER TERMINATOR
	// Regular 0x1A + Second miss terminator = CRASH
	